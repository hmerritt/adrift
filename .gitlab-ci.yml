stages:
    - test
    - build
    - release

variables:
    DOCKER_USER: $DOCKER_USER
    DOCKER_TOKEN: $DOCKER_TOKEN

test:
    image: node:18-alpine

    cache:
        paths:
            - node_modules/

    before_script:
        - npm install
        - npm --depth 9999 update

    script:
        - npm run test:coverage
        - unset CI
        - npm run build

    coverage: /All\sfiles.*?\s+(\d+.\d+)/

release:
    image: docker:19.03.1
    stage: build

    only:
        - tags

    services:
        - name: docker:19.03.1-dind
          command: ["--experimental"]

    before_script:
        - npm install
        - npm run build

    script:
        - docker login -u "$DOCKER_USER" -p "$DOCKER_TOKEN"
        - docker build -t hmerritt/APPNAME:$CI_COMMIT_TAG -t hmerritt/APPNAME:latest .
        - docker push hmerritt/APPNAME

    after_script:
        - docker logout
